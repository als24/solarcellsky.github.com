function pathRect(t,i,e,h,s){t.moveTo(i,e),t.lineTo(i,e+s),t.lineTo(i+h,e+s),t.lineTo(i+h,e),t.lineTo(i,e)}function view(){return{w:$(".image-box").width(),h:$(".image-box").height()}}function extend(t,i){for(var e in i)t[e]=i[e]}function addEvent(t,i,e){t.attachEvent?t.attachEvent("on"+i,e):t.addEventListener(i,e,!1)}function removeEvent(t,i,e){t.detachEvent?t.detachEvent("on"+i,e):t.removeEventListener(i,e,!1)}var ImgClip=function(t){this.canvas=null,this.fileObj=null,this.cutBtn=null,this.resultObj=null,this.winSize={w:300,h:300},this.ctx=null,this.img=null,this.dataURL=null,this.dis={x:0,y:0},this.pre={x:0,y:0},this.prex=this.prey=0,this.flagX=!0,this.r=1,this.rMax=1,this.rMin=.25,this.rr=1,this.rDis=0,this.imageSize={w:0,h:0},this.cutSize={w:0,h:0,t:0,l:0},this.cutFast=!1,this.tstate="end",this.cutScale=1,this.cutW=0,this.paddB=100,this.rot=0,this.isRotate=!1,t&&this.init(t)},hasChoose=!1;ImgClip.prototype={init:function(t){if(!t)return!1;var i=this;this.canvas=this.getObj(t.canvas),this.ctx=this.canvas.getContext("2d"),this.fileObj=this.getObj(t.fileObj),this.cutBtn=this.getObj(t.cutBtn),this.resultObj=this.getObj(t.resultObj),this.cutScale=parseFloat(t.cutScale),this.winSize={w:view().w,h:view().h},t.cutW=.9*this.winSize.w;var e=parseInt(t.cutW*this.cutScale);this.cutSize={w:t.cutW,h:e,t:(this.winSize.h-e)/2,l:(this.winSize.w-t.cutW)/2},this.setCanvas(this.canvas),this.clearCanvas(this.canvas),this.ctx.fillStyle="rgba(0,0,0,0)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),t.rotateR&&(this.rotateR=this.getObj(t.rotateR)),addEvent(this.fileObj,"change",function(t){t.target.files[0]&&(i.r=1,i.rot=0,i.isRotate=!1,i.run(t,i))}),addEvent(this.cutBtn,"click",function(t){i.getResults(t)}),t.rotateR&&addEvent(this.getObj(t.rotateR),"click",function(){if(null!==i.img){3==i.rot?i.rot=0:i.rot++;var t=i.r,e=1,h=1;if(1==i.rot||3==i.rot){var s=i.imageSize.h,a=i.imageSize.w;h=i.cutSize.h/i.img.width,e=i.cutSize.w/i.img.height}else{var s=i.imageSize.w,a=i.imageSize.h;h=i.cutSize.h/i.img.height,e=i.cutSize.w/i.img.width}return i.clearCanvas(i.canvas),i.ctx.fillStyle="#000",i.ctx.fillRect(0,0,i.canvas.width,i.canvas.height),i.isRotate=!0,i.ctx.save(),i.ctx.translate(i.prex+a/2,i.prey+s/2),i.ctx.rotate(90*i.rot*Math.PI/180),i.ctx.drawImage(i.img,-i.imageSize.w/2,-i.imageSize.h/2,i.imageSize.w,i.imageSize.h),i.ctx.restore(),i.drawUI(i.ctx,i.cutSize),i.prex=i.pre.x=i.prex-(s/2-a/2),i.prey=i.pre.y=i.prey-(a/2-s/2),i.rMin=e>t||h>t?i.r=e>h?e:h:e>h?e:h,i.rMax=Math.max(2*i.rMin,1),i.r!=t?doMove(i,{TRx1:i.prex,TRy1:i.prey,r1:t,TRx2:i.prex,TRy2:i.prey,r2:i.r},"easeBoth",300,function(){i.toMove(i)}):i.toMove(i),!1}})},run:function(t,i){t=t||window.event;var e,h=t.target.files,s=h[0],a=0;EXIF.getData(s,function(){switch(e=EXIF.getTag(this,"Orientation")){case 3:a=180,i.rot=2;break;case 6:a=90,i.rot=1;break;case 8:a=270,i.rot=3}i.pre.x=i.pre.y=i.prex=i.prey=0,i.img=null,resolveObjectURL(i.dataURL),i.dataURL=createObjectURL(s),i.drawImg(0,0,function(){i.tstate="ok",addEvent(i.canvas,"touchstart",function(t){t.stopPropagation(),i.fntouchstart(t),addEvent(document,"touchmove",function(t){t.stopPropagation(),i.fntouchmove(t)}),addEvent(document,"touchend",function(t){t.stopPropagation(),i.fntouchend(t)})}),addEvent(i.canvas,"mousedown",function(t){t.stopPropagation(),i.fntouchstart(t),addEvent(document,"mousemove",function(t){t.stopPropagation(),i.fntouchmove(t)}),addEvent(document,"mouseup",function(t){t.stopPropagation(),i.fntouchend(t)})})})})},drawImg:function(t,i,e){if(this.clearCanvas(this.canvas),this.ctx.fillStyle="rgba(0,0,0,0)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),$(".xx1").hide(),$(".te3").show(),$("#rotateBtn").show(),$("#clipBtn").show(),$("#myBtn").hide(),null===this.img){this.img=new Image;var h=this;this.img.onload=function(){h.clearCanvas(h.canvas),h.ctx.fillStyle="rgba(0,0,0,0)",h.ctx.fillRect(0,0,h.canvas.width,h.canvas.height),h.imageSize={w:this.width,h:this.height};var e=1,s=1;s=h.cutSize.h/this.height,e=h.cutSize.w/this.width,this.height<h.cutSize.h||this.width<h.cutSize.w?h.rMin=h.r=e>s?e:s:this.height>h.canvas.height&&this.width>h.canvas.width&&(h.rMin=e>s?e:s,s=h.canvas.height/this.height,e=h.canvas.width/this.width,h.r=e>s?e:s),h.rMax=Math.max(2*h.rMin,1),h.imageSize.w=this.width*h.r,h.imageSize.h=this.height*h.r,t=h.prex=h.pre.x=h.winSize.w/2-h.imageSize.w/2,i=h.prey=h.pre.y=h.winSize.h/2-h.imageSize.h/2,h.ctx.save(),0!=h.rot?(h.isRotate=!0,1==h.rot||3==h.rot?h.ctx.translate(t+h.imageSize.h/2,i+h.imageSize.w/2):h.ctx.translate(t+h.imageSize.w/2,i+h.imageSize.h/2),h.ctx.rotate(90*h.rot*Math.PI/180),h.ctx.drawImage(this,-h.imageSize.w/2,-h.imageSize.h/2,h.imageSize.w,h.imageSize.h),h.toMove(h)):(h.ctx.translate(h.canvas.width/2,h.canvas.height/2),h.ctx.drawImage(this,-h.imageSize.w/2,-h.imageSize.h/2,h.imageSize.w,h.imageSize.h)),h.ctx.restore(),h.prex=h.pre.x=h.canvas.width/2-h.imageSize.w/2,h.prey=h.pre.y=h.canvas.height/2-h.imageSize.h/2,h.drawUI(h.ctx,h.cutSize)},this.img.src=this.dataURL}else this.ctx.save(),this.isRotate?(1==this.rot||3==this.rot?this.ctx.translate(t+this.imageSize.h/2,i+this.imageSize.w/2):this.ctx.translate(t+this.imageSize.w/2,i+this.imageSize.h/2),this.ctx.rotate(90*this.rot*Math.PI/180),this.ctx.drawImage(this.img,-this.imageSize.w/2,-this.imageSize.h/2,this.imageSize.w,this.imageSize.h)):(this.ctx.translate(t+this.imageSize.w/2,i+this.imageSize.h/2),this.ctx.drawImage(this.img,-this.imageSize.w/2,-this.imageSize.h/2,this.imageSize.w,this.imageSize.h)),this.ctx.restore(),this.drawUI(this.ctx,this.cutSize);e&&e()},fntouchstart:function(t){var t=t||window.event;if(t.preventDefault(),t.stopPropagation(),this.rDis=0,"touchstart"==t.type&&2==t.touches.length){var i=t.touches[0].clientX-t.touches[1].clientX,e=t.touches[0].clientY-t.touches[1].clientY;this.rDis=Math.sqrt(i*i+e*e)}return"ok"==this.tstate?(this.tstate="start",this.rr=this.r,this.dis.x=("mousedown"==t.type?t.clientX:t.touches[0].clientX)-this.pre.x,this.dis.y=("mousedown"==t.type?t.clientY:t.touches[0].clientY)-this.pre.y,!1):void 0},fntouchmove:function(t){var t=t||window.event;t.stopPropagation(),t.preventDefault();var i=this;if("start"==this.tstate){var e=("mousemove"==t.type?t.clientX:t.touches[0].clientX)-this.dis.x,h=("mousemove"==t.type?t.clientY:t.touches[0].clientY)-this.dis.y;if("touchmove"==t.type&&2==t.touches.length){var s=t.touches[0].clientX-t.touches[1].clientX,a=t.touches[0].clientY-t.touches[1].clientY,n=Math.sqrt(s*s+a*a),r=i.rr,o=r*(n/i.rDis);o<i.rMin/2&&(o=i.rMin/2),o>1.5*i.rMax&&(o=1.5*i.rMax),i.imageSize.w=i.img.width*o,i.imageSize.h=i.img.height*o,e-=i.imageSize.w/2-i.img.width*r/2,h-=i.imageSize.h/2-i.img.height*r/2,i.r=o}this.drawImg(e,h,function(){i.prex=e,i.prey=h})}},fntouchend:function(t){if(t.stopPropagation(),"ok"!=this.tstate){this.tstate="ok",document.onmousemove=null,document.ontouchmove=null,this.pre.x=this.prex,this.pre.y=this.prey;var i=this.r,e=this;if(this.r<this.rMin)this.r=this.rMin,doMove(this,{TRx1:this.prex,TRy1:this.prey,r1:i,TRx2:this.prex,TRy2:this.prey,r2:this.r},"easeBoth",300,function(){e.toMove(e)});else if(this.r>this.rMax){this.r=this.rMax;var h=this.prex,s=this.prey;this.pre.x=this.prex-=-(e.img.width*i/2)+e.img.width*this.r/2,this.pre.y=this.prey-=-(e.img.height*i/2)+e.img.height*this.r/2,doMove(this,{TRx1:h,TRy1:s,r1:i,TRx2:this.prex,TRy2:this.prey,r2:this.r},"easeBoth",300,function(){e.toMove(e)})}else this.toMove(this)}},toMove:function(t,i,e,h){if(1==t.rot||3==t.rot)var s=t.imageSize.h,a=t.imageSize.w;else var s=t.imageSize.w,a=t.imageSize.h;var n={left:t.cutSize.l,right:t.cutSize.l+t.cutSize.w,top:t.cutSize.t,bottom:t.cutSize.t+t.cutSize.h},r=t.prex,o=t.prey;t.prex+s<n.right&&(t.prex=t.pre.x=n.right-s),t.prex>n.left&&(t.prex=t.pre.x=n.left),t.prey+a<n.bottom&&(t.prey=t.pre.y=n.bottom-a),t.prey>n.top&&(t.prey=t.pre.y=n.top),doMove(t,{TRx1:r,TRy1:o,TRx2:t.prex,TRy2:t.prey},"easeOut",500,function(){h&&h()})},getResults:function(){if(this.dataURL){if(document.getElementById("vData"))var t=document.getElementById("vData");else{var t=document.createElement("canvas");t.style.display="none",t.id="vData",this.resultObj.parentNode.appendChild(t)}var i=t.getContext("2d");return t.width=this.cutSize.w,t.height=this.cutSize.h,i.drawImage(this.canvas,this.cutSize.l+.5,this.cutSize.t+.5,this.cutSize.w-1,this.cutSize.h-1,0,0,t.width,t.height),this.resultObj.src=t.toDataURL(),this.resultObj.src}},getObj:function(t){return"string"==typeof t?document.getElementById(t):t},clearCanvas:function(t){var i=t.getContext("2d");i.clearRect(0,0,t.width,t.height)},setCanvas:function(t){t.width=this.winSize.w,t.height=this.winSize.h},drawUI:function(t,i){t.beginPath(),t.rect(0,0,t.canvas.width,t.canvas.height),pathRect(t,i.l,i.t,i.w,i.h),t.closePath(),t.fillStyle="rgba(0,0,0,0.3)",t.fill(),t.lineWidth=1,t.strokeStyle="#ee8a81",t.strokeRect(i.l-1.5,i.t-1.5,i.w+3,i.h+3)}};var createObjectURL=function(t){return window[window.URL?"URL":"webkitURL"].createObjectURL(t)},resolveObjectURL=function(t){window[window.URL?"URL":"webkitURL"].revokeObjectURL(t)};