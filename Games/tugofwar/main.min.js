var Game=function(e){function t(){e.call(this),this.teamBlue=[],this.teamYellow=[],this.isGameStart=!1,this.hasReslut=!1,this._initSck=!1,this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(t,e);var i=(__define,t);return p=i.prototype,p.onAddToStage=function(){var e=RES.getRes("bg1_mp3"),t=RES.getRes("bg2_mp3"),i=RES.getRes("bg3_mp3"),a=RES.getRes("match_mp3"),s=RES.getRes("eff1_wav"),n=RES.getRes("eff2_wav");this.music={bg:[e,t,i],match:a,eff1:s,eff2:n},!window._conf.debug&&this.playBG(),this.connectSrv(),this.isWanda="wanda"==this.getQueryString("cus")},p._ramdon=function(e){return e.sort(function(){return Math.random()>.5?-1:1})[0]},p.playBG=function(){var e=this._ramdon(this.music.bg);this.bgMusic=e.play(0,-1)},p.getQueryString=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),i=window.location.search.substr(1).match(t);return null!=i?i[2]:null},p.createView=function(){var e=this.stage.stageWidth,t=this.stage.stageHeight;if(!this.isWanda){var i=this.getQueryString("ui");i=i?i+"_":"";var a=new egret.Bitmap(RES.getRes(i+"vs_png"));a.x=(e-a.width)/2,a.y=50,this.addChild(a)}var s=new egret.Bitmap;"xb001"==this.getQueryString("licence")?(console.log("测试账号"),s.texture=RES.getRes("xblogo_png")):s.texture=RES.getRes("midline"),s.x=(e-s.width)/2+8,s.y=500,this.addChild(s);var n=this.line=new egret.Bitmap(RES.getRes("line")),h=this.matchCtn=new egret.DisplayObjectContainer;h.width=n.width,h.height=430,h.x=(e-n.width)/2,h.y=460,n.y=h.height-n.height,h.addChild(n),this.addChild(h);for(var o=this.mcMix=new egret.MovieClipDataFactory(RES.getRes("mix_json"),RES.getRes("mix_png")),r=this.teamMember,l=0;r>l;l++){var d=new Player({team:"blue",id:l+1});this.teamBlue.push(d),d.x=30+190*(2-l),h.addChild(d)}for(var l=0;r>l;l++){var d=new Player({team:"yellow",id:l+1});this.teamYellow.push(d),d.x=1100+190*l,h.addChild(d)}var g=this.rope=new egret.MovieClip(o.generateMovieClipData("rope"));g.x=(h.width-g.width)/2-10,g.y=300,g.visible=!1,h.addChild(g);var c=new egret.MovieClip(o.generateMovieClipData("lalaBlue_side")),u=new egret.MovieClip(o.generateMovieClipData("lalaBlue_mid")),p=new egret.MovieClip(o.generateMovieClipData("lalaBlue_side")),v=new egret.MovieClip(o.generateMovieClipData("lalaYellow_side")),w=new egret.MovieClip(o.generateMovieClipData("lalaYellow_mid")),R=new egret.MovieClip(o.generateMovieClipData("lalaYellow_side"));this.lala=new egret.DisplayObjectContainer,this.lala.width=1920,this.lala.height=250,this.lala.x=(e-this.lala.width)/2,this.lala.y=960,this.lala.visible=!1,u.x=240,p.x=480,v.x=1130,w.x=1410,R.x=1690,c.play(-1),u.play(-1),p.play(-1),v.play(-1),w.play(-1),R.play(-1),this.lala.addChild(c),this.lala.addChild(u),this.lala.addChild(p),this.lala.addChild(v),this.lala.addChild(w),this.lala.addChild(R),this.addChild(this.lala);var m=this.judgment=new egret.MovieClip(o.generateMovieClipData("judgment"));m.x=(e-m.width)/2+50,m.y=h.height+h.y-30,this.addChild(m);var C=new egret.MovieClipDataFactory(RES.getRes("audience_json"),RES.getRes("audience_png")),E=this.audience=new egret.MovieClip(C.generateMovieClipData("audience"));E.x=(e-E.width)/2,E.y=t-E.height,E.visible=!1,this.addChild(E)},p.connectSrv=function(){var e=window._conf.host,t=window._conf.port,i=this.socket=io.connect("ws://"+e+":"+t+"/board"),a=this,s=this.getQueryString("licence"),n=parseInt(this.getQueryString("no"));this.teamMember=1==n||2==n||3==n?n:2,i.on("connect",function(){i.emit("login",{licence:s,no:n})}),i.on("loginSuccessful",function(){a.createView.call(a),a.initSckEvent.call(a)}),i.on("roomErr",function(e){window.debug?console.log(e.msg):alert(e.msg)})},p.initSckEvent=function(){if(!this._initSck){this._initSck=!0;var e=this.socket,t=this;e.on("code",function(e){console.log("sck:code=>",e),window.showQRcode(e),t.lala.visible=!1,t.audience.visible=!1,t.reset.call(t)}),e.on("userIn",function(e){console.log("sck:userIn=>",e);var i="blue"==e.team?t.teamBlue:t.teamYellow;i[e.teamNo].roleIn(e.avt),t.music.eff1.play(0,1)}),e.on("start",function(){console.log("sck:start"),t.showCountDown(),window.hideQRcode(),t.lala.visible=!0,t.audience.visible=!0,t.bgMusic.stop(),t.music.match.play(0,-1)});var i=this.matchCtn.x;e.on("power",function(e){if(t.isGameStart){var a=e.blue/window._conf.winLine*300;egret.Tween.get(t.matchCtn).to({x:i-a},400),Math.random()>.6}}),e.on("gameover",function(e){console.log("sck:gameover=>",e),t.gameOver.call(t,e),t.music.match.stop(),t.playBG.call(t)})}},p.showCountDown=function(){if(!this.cdCtn){var e=this.cdCtn=new egret.DisplayObjectContainer,t=this.stage.stageWidth,i=this.stage.stageHeight,a=new egret.Shape;a.graphics.beginFill(0,.2),a.graphics.drawRect(0,0,t,i),a.graphics.endFill(),e.addChild(a);var s=this.cdTxt=new egret.Bitmap(RES.getRes("cd3"));s.x=(t-s.width)/2,s.y=(i-s.height)/2,e.addChild(s),this.addChild(e)}this.cdCtn.visible=!0;var n=new egret.Timer(1e3,4),h=3;n.addEventListener(egret.TimerEvent.TIMER,function(){this.cdTxt.texture=RES.getRes(--h<2?"cdgo":"cd"+(h-1)),this.cdTxt.x=(t-this.cdTxt.width)/2,this.cdTxt.y=(i-this.cdTxt.height)/2},this),n.addEventListener(egret.TimerEvent.TIMER_COMPLETE,function(){this.cdCtn.visible=!1,this.cdTxt.texture=RES.getRes("cdgo"),this.start()},this),n.start()},p.gameOver=function(e){this.isGameStart=!1,this.showResult(e)},p.showResult=function(e){var t=this.resultCtn=new egret.DisplayObjectContainer,i=new egret.Shape;i.graphics.beginFill(0,.2),i.graphics.drawRect(0,0,this.stage.stageWidth,this.stage.stageHeight),i.graphics.endFill(),t.addChild(i),this.hasReslut=!0;var a=new egret.DisplayObjectContainer,s=this.getQueryString("ui");s=s?s+"_":"";var n=new egret.Bitmap(RES.getRes("blue"==e.winner?s+"winbg_blue_png":s+"winbg_yellow_png"));a.width=n.width,a.height=n.height,a.x=(this.stage.stageWidth-n.width)/2,a.y=(this.stage.stageHeight-n.height)/2,a.addChild(n),t.addChild(a);for(var h=[135,338,536],o="blue"==e.winner?this.teamBlue:this.teamYellow,r=0,l=o.length;l>r;r++){var d=o[r].avatar;o[r].hasAvatar=!1,d.x=h[r],d.y=742,d.scaleX=150/d.width,d.scaleY=150/d.height,a.addChild(d);var g=new egret.Bitmap(RES.getRes("blue"==e.winner?"crown_blue":"crown_yellow"));g.x=h[r]-40,g.y=680,a.addChild(g)}this.addChild(t)},p.reset=function(){this.hasReslut&&this.removeChild(this.resultCtn),this.hasReslut=!1,this.matchCtn.x=(this.stage.stageWidth-this.matchCtn.width)/2,this.line.y=this.matchCtn.height-this.line.height,this.rope.visible=!1,this.rope.stop();for(var e=0,t=this.teamBlue.length;t>e;e++)this.teamBlue[e].reset(),this.teamYellow[e].reset();this.judgment.stop(),this.audience.stop()},p.start=function(){this.isGameStart=!0,this.line.y=270,this.rope.visible=!0,this.rope.play(-1);for(var e=0,t=this.teamBlue.length;t>e;e++)this.teamBlue[e].fight(),this.teamYellow[e].fight();this.judgment.play(-1),this.audience.play(-1)},t}(egret.DisplayObjectContainer);egret.registerClass(Game,"Game");var LoadingUI=function(e){function t(){e.call(this),this.createView()}__extends(t,e);var i=(__define,t);return p=i.prototype,p.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},p.setProgress=function(e,t){this.textField.text="Loading..."+e+"/"+t},t}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(e){function t(){e.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(t,e);var i=(__define,t);return p=i.prototype,p.onAddToStage=function(){RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},p.onReceiveMessage=function(e){console.log(e)},p.onSocketOpen=function(){console.log("connect")},p.onConfigComplete=function(){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.loadGroup("preload")},p.onResourceLoadComplete=function(e){if("preload"==e.groupName){var t=this.getSearch("ui")||"default";console.log(t,"fuck UI"),RES.loadGroup(t)}else RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),this.stage.addChild(new Game),this.stage.removeChild(this)},p.getSearch=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),i=window.location.search.substr(1).match(t);return null!=i?i[2]:null},p.onResourceLoadError=function(e){console.warn("Group:"+e.groupName+" has failed to load"),this.onResourceLoadComplete(e)},p.onResourceProgress=function(e){"preload"==e.groupName},t}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");var Player=function(e){function t(t){e.call(this),this.hasAvatar=!1,this.data=t,this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(t,e);var i=(__define,t);return p=i.prototype,p.onAddToStage=function(){this.width=190,this.height=350;var e="blue"==this.data.team?"teamBlue":"teamYellow",t=new egret.MovieClipDataFactory(RES.getRes(e+"_json"),RES.getRes(e+"_png")),i=this.viewWait=new egret.MovieClip(t.generateMovieClipData("p"+this.data.id+"w")),a=this.viewFight=new egret.MovieClip(t.generateMovieClipData("p"+this.data.id+"f"));this.viewFight.visible=!1,i.x=(this.width-i.width)/2,i.y=this.height-i.height,a.x=(this.width-a.width)/2,a.y=this.height-a.height,"blue"==this.data.team&&3==this.data.id&&(a.y+=30),"blue"==this.data.team&&2==this.data.id&&(a.y+=40),"yellow"==this.data.team&&3==this.data.id&&(i.y=154,a.y+=20),this.addChild(this.viewWait),this.addChild(this.viewFight);var s=new egret.Bitmap(RES.getRes("holder"));s.x=(this.width-s.width)/2,this.addChild(s)},p.reset=function(){this.viewWait.stop(),this.viewWait.visible=!0,this.viewFight.visible=!1,this.viewFight.stop(),this.hasAvatar&&this.removeChild(this.avatar),this.hasAvatar=!1},p.roleIn=function(e){this.showAvatar(e),this.viewWait.play(-1)},p.showAvatar=function(e){if(!this.hasAvatar){var t=this.avatar=new egret.Bitmap;t.x=this.width/2-50,t.y=6,RES.getResByUrl(e,function(e){t.texture=e,t.scaleX=100/e.textureWidth,t.scaleY=100/e.textureHeight,this.addChild(t)},this,RES.ResourceItem.TYPE_IMAGE),this.hasAvatar=!0}},p.fight=function(){this.viewWait.stop(),this.viewWait.visible=!1,this.viewFight.visible=!0,this.viewFight.play(-1)},t}(egret.Sprite);egret.registerClass(Player,"Player");