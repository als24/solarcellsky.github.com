define("mactivity:widget/huodong/WaimaiTwoYear/TwoYearCoupon",function(require,exports,module){var Dialog=require("mactivity:widget/common/dialog/dialog"),Stat=require("mactivity:static/common/stat"),Invoke=require("mactivity:widget/common/platformInvoke/invoke"),Popup=require("mactivity:widget/common/popup/popup"),Cookie=require("mactivity:static/common/Cookie"),shareIcon="http://waimai.baidu.com/static/static/share-grab-icon.jpg",loginTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="inner dialog login">    <div class="dialog-head">        <div class="dialog-times close"></div>        <span>登录</span>        <div class="dialog-border"></div>    </div>    <div class="dialog-body">        <form>            <div><input class="form-input" type="tel" placeholder="请填写手机号" id="phone" pattern="[0-9]*"/></div>            <div class="validcode-block">                <input class="form-input input-sm" type="tel" id="validcode" placeholder="请输入验证码" pattern="[0-9]*"/>                <button class="valicode-btn" id="sendValicode">验证码</button>            </div>        </form>    </div>    <div class="dialog-footer">        <div class="gotoloot"><span>立刻抢红包</span></div>    </div></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],ruleTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="inner dialog activity">    <div class="dialog-head">        <div class="close dialog-times"></div>        <span>活动规则</span>        <div class="dialog-border"></div>    </div>    <div class="dialog-body">        <div class="huodong-content">            ');var _len=data.length;_template_fun_array.push("            ");for(var i=0;_len>i;i++){_template_fun_array.push("                ");var _obj=data[i];_template_fun_array.push("                "),i!=_len-1?_template_fun_array.push('                <div class="content-item clearfix">                    <span class="item-num">',"undefined"==typeof(i+1)?"":baidu.template._encodeHTML(i+1),'</span>                    <span class="item-desc">',"undefined"==typeof _obj?"":baidu.template._encodeHTML(_obj),"</span>                </div>                "):_template_fun_array.push('                <div class="content-item item-last clearfix">                    <span class="item-num">',"undefined"==typeof(i+1)?"":baidu.template._encodeHTML(i+1),'</span>                    <span class="item-desc">',"undefined"==typeof _obj?"":baidu.template._encodeHTML(_obj),"</span>                </div>                "),_template_fun_array.push("            ")}_template_fun_array.push("        </div>    </div></div>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],quanTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="inner dialog">    <section class="pop">        <div class="quan-pop">            <span class="close"></span>            <h4 class="win-prize">恭喜你抢中了',"undefined"==typeof data.total_amount?"":baidu.template._encodeHTML(data.total_amount),'元</h4>            <p class="hit-msg">更多100减99的大额券等你来抢！</p>            <div class="hit-line"></div>            <div class="quan-food">                ');var _objList=data.coupons;_template_fun_array.push("                ");for(var item in _objList){_template_fun_array.push("                    ");var _obj=_objList[item];_template_fun_array.push('                    <div class="quan-wrap">                        '),_obj.new_user&&_template_fun_array.push('                        <span class="newuser"></span>                        '),_template_fun_array.push('                        <div class="quan-left">                            <span class="money">￥</span>                            <span class="quan-prize">',"undefined"==typeof _obj.amount?"":baidu.template._encodeHTML(_obj.amount),'</span>                        </div>                        <div class="quan-right">                            <h4 class="quan-type">',"undefined"==typeof _obj.coupon_name?"":baidu.template._encodeHTML(_obj.coupon_name),'</h4>                            <p class="quan-limit"> 满',"undefined"==typeof _obj.limit_amount?"":baidu.template._encodeHTML(_obj.limit_amount),"使用</p>                        </div>                    </div>                ")}_template_fun_array.push('                <div class="bottom-line"></div>            </div>            '),data.share&&_template_fun_array.push('            <div class="share-block"><a class="naShare" href="#">手气分享给小伙伴</a></div>            '),_template_fun_array.push("        </div>    </section></div>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],DIALOGMAP={LOGIN:[loginTmpl],RULE:[ruleTmpl],QUAN:[quanTmpl]},canSmallJump=!0,smallJumpTime,timestamp=(new Date).getTime(),TIPMESSAGE=["力气太小,还没吃饱？","原地跳三跳,大力顶红包~","大喊一声我爱你,再顶一次！","100块还有好多,加油加油！","顶出100块，就差一点！","亲我一口,好运就有！","顶不出红包的宝宝不是好小熊！","100块刚被你左边的人顶走了！","100块都不给你？我给！","敢不敢再顶我一次？！"],RANDOMTEXT={big:"百度外卖周年礼已到手，快来领，手慢无！","default":"百度外卖520周年庆，亿元福利狂撒三天，带敢来抢！"},CONFIG520={share:{big:"百度外卖周年礼已到手，快来领，手慢无！","default":"百度外卖520周年庆，亿元福利狂撒三天，带敢来抢！"},rule:["活动时间：2016年5月18日-20日","活动期间，每人最高可获取代金券的总金额为520元","活动领取代金券不与百度外卖其他任何优惠同享","代金券仅限领取时的账号使用，不可提现、转赠、买卖、兑现、转赠他人，不得为他人付款","代金券仅限在本地商家订单中使用","百度外卖代金券有限期为：领取激活后 7 天内有效，过期作废","如下单时，券面额大于等于实际支付金额，需用户强制支付 0.01 元","代金券仅限最新版的“百度外卖”iOS、Android客户端，以及百度渠道手机客户端下单，并在线支付使用","每个用户每天限使用一张代金券；同一账号，绑定电话，设备，支付宝账号、银行卡等与用户身份相同、相似或非真实有效等情形的，均认定为同一用户，按活动规则中同一用户处理","百度外卖未在任何网络交易平台出售代金券（或帐户），也未授权任何企业或个人进行销售，非参与百度外卖官方营销活动获得的代金券（或帐户）均视为非正规渠道所获得（批量注册、 领取、 虚假交易等）百度外卖有权将此类代金券作废处理，对涉及百度账号进行封禁处理，并追究其法律责任的权利","如有疑问，请联系百度外卖客服400-011-7777"]},ISOVERTEXT=["机会用完了，明天再来抢","明天还有更多大红包","今天抢太多了，0点以后继续抢"];module.exports=Widget.extend({canSendCheckCode:!0,events:{"tap .bag":"goToBag","tap #help":"showRule","click .close":"closeDialog","tap .naShare":"naShare","tap #music-btn":"eventHandle","doubleTap #music-btn":"eventHandle","tap #music-control":"musicControl"},urls:{toBag:"http://huodong.waimai.baidu.com/huodong/twoyearmypacket",doGrab:"/huodong/twoyearlottery",sendPhoneMes:"/huodong/twoyearcoupon",checkPhoneMes:"/huodong/twoyearcoupon"},init:function(a){var e=this;e.data=a?a:{},Stat.addStat("SAK",{da_trd:"waimai",da_src:"activity.520coupon.show",da_act:"show"});var t=a?a.result:{};e.openid=t.open_id||"",e.redirectUrl(),this.initInvoke(),e.dialog=new Dialog({el:".dialog520"}),e._initWinningMes(t),e._scrollup(),e._bearSmallJump(),e.landscapeListen()},redirectUrl:function(){if(window.isWechat){var a=location.href;a.indexOf("share=wxshare")<0&&(location.href="http://huodong.waimai.baidu.com/huodong/twoyearcoupon?share=wxshare")}},initInvoke:function(){var a=this;isWechat?$.ajax({url:"http://waimai.baidu.com/fly/h5/rest/getwxtoken",data:{url:location.href},dataType:"jsonp",success:function(e){var t=e.result;a.setShare(t)},error:function(){}}):a.setShare({})},setShare:function(a){var e=this,t=e.shareUrlTimestamp();Invoke.init(a,{title:"百度外卖2周年，狂撒1亿周年礼！",desc:"最高可领520元，敢玩你就带敢来！",link:t,imgUrl:shareIcon,headerTitle:"亿元红包疯狂顶"})},setShareHandle:function(a,e){var t=a-e;return 1==t?"满"+a+"-"+e+"元"+RANDOMTEXT.big:RANDOMTEXT["default"]},naShare:function(){var a=this,e=a.grabed,t=a.setShareHandle(e.limit_amount,e.amount),n=a.shareUrlTimestamp(),i={title:"百度外卖2周年，狂撒1亿周年礼！",description:"最高可领520元，敢玩你就带敢来！",linkUrl:n,imageUrl:shareIcon,headerTitle:"两周年顶红包"};$.extend(i,{description:t}),WMApp.share.share(i)},shareUrlTimestamp:function(){var a="http://huodong.waimai.baidu.com/huodong/"+timestamp+"/twoyearcoupon?share=wxshare";return a},goToBag:function(){var a=this;window.isWechat&&a.linkToBag(),WMAppReady(function(){a.data.result.is_login?a.linkToBag():WMApp.account.login(function(e){e.status&&a.linkToBag()})})},linkToBag:function(){var a=isWechat?this.urls.toBag+"?share=wxshare&open_id="+this.openid:this.urls.toBag;Invoke.jumpTo("url",{url:a})},showRule:function(){this.dialog.show(DIALOGMAP.RULE,CONFIG520.rule)},closeDialog:function(){var a=this;a.dialog.close()},musicControl:function(){var a=$("#music-control"),e=$(".music"),t=e.length;if(a.is(":checked"))for(var n=0;t>n;n++)$(".music")[n].pause()},_initWinningMes:function(a){var e=$(".content-list");if(!a)return!1;for(var t=a.scroll_word?a.scroll_word:[],n=t.length?t.length:0,i="",o=0;n>o;o++){var s=t[o];i=i+"<span>"+s+"</span>"}e.prepend(i)},_scrollup:function(){function a(){clearTimeout(e),e=setTimeout(function(){s+=o,s>=o*(i+1)?(n.css({"-webkit-transition":"0s ease-in-out","-webkit-transform":"translateY(0)"}),s=0):n.css({"-webkit-transition":"1s ease-in-out","-webkit-transform":"translateY(-"+s+"px)"}),a()},1800)}var e,t=$(".content-list span"),n=$(".content-list"),i=t.length,o=t.height(),s=0;a()},_bearSmallJump:function(){var a=$(".block-bear");a.off("animationend webkitAnimationEnd").on("animationend webkitAnimationEnd",function(){a.removeClass("block-bear-smalljump"),smallJumpTime&&clearTimeout(smallJumpTime),smallJumpTime=setTimeout(function(){canSmallJump&&a.addClass("block-bear-smalljump")},1e3)})},_bearBigJump:function(){var a=this,e=$("#music-btn"),t=$(".block-bear");canSmallJump=!1,t.removeClass("block-bear-smalljump").addClass("block-bear-bigjump"),e.prop("disabled",!0),a._animationMusic()},_animationMusic:function(){var a,e=this,t=$("#music-btn"),n=$(".block-bear"),i=$("#music-control"),o=$(".music").length,s=Math.floor(Math.random()*o),l=$('[data-id="'+s+'"]')[0];i.is(":checked")?l.pause():l.play(),n.off("animationend webkitAnimationEnd").on("animationend webkitAnimationEnd",function(){var n=$(this);canSmallJump=!0,t.removeAttr("disabled"),n.removeClass("block-bear-bigjump"),a&&clearTimeout(a),a=setTimeout(function(){n.addClass("block-bear-smalljump")},1e3),e._bearSmallJump()})},_tipAnimation:function(){var a=$(".block-tipMes"),e=Math.floor(Math.random()*(TIPMESSAGE.length-1)+1);!a.hasClass("block-tipMesshow")&&a.addClass("block-tipMesshow"),a.off("animationend webkitAnimationEnd").on("animationend webkitAnimationEnd",function(){a.removeClass("block-tipMesshow").find("span").text(TIPMESSAGE[e])})},_doGrab:function(){var a=this,e=($(".content-list"),{});window.isWechat&&$.extend(e,{open_id:a.data.result.open_id,share:"wxshare"});a.data.result.open_id;$.ajax({url:a.urls.doGrab,type:"post",data:e,dataType:"json",cache:"false",success:function(e){if(0==e.error_no){a.data.result.is_login=1;var t=e.result;if(a._initWinningMes(t),t.is_get){window.isWechat?$.extend(t,{share:!1}):$.extend(t,{share:!0}),a.dialog.show(DIALOGMAP.QUAN,t);var n=t.coupons[0];a.grabed=n;var i=a.setShareHandle(n.limit_amount,n.amount);Invoke.setShare({title:i})}else if(1==t.is_over){var o=Math.floor(Math.random()*ISOVERTEXT.length);if(window.WMApp&&"object"==typeof window.WMApp){var s={text:ISOVERTEXT[o],duration:"short"};WMApp.nui.toast(s)}else Popup.open(ISOVERTEXT[o])}}else("30016"==e.error_no||"30020"==e.error_no)&&a._login()}})},_login:function(a){var a=this;isWechat&&a.dialog.show(DIALOGMAP.LOGIN,{},function(){var e=$("#sendValicode");e.unbind("click").bind("click",function(e){e.preventDefault();var t=a._phoneMesValid();t&&a._sendCodeAjax(a)});var t=$(".gotoloot");t.unbind("click").bind("click",function(e){e.preventDefault();var t=a._loginFormValid();t&&a._checkCodeAjax(a)})}),WMAppReady(function(){WMApp.account.login(function(a){a.status})})},_phoneMesValid:function(){var a=$("#phone").val(),e=/^1\d{10}$/g,t=!1;return a?e.test(a)?t=!0:Popup.open("手机号输入有误！"):Popup.open("请输入手机号！"),t},_sendCodeAjax:function(a){var e=$("#phone").val();$.ajax({type:"GET",url:a.urls.sendPhoneMes,dataType:"json",cache:!1,data:{mobile:e,opt:"send_code",share:"wxshare",display:"json"},success:function(e){"0"==e.error_no?a._sendCodeCountDown(a):Popup.open(e.error_msg)},error:function(){Popup.open("发送失败~")}})},_sendCodeCountDown:function(a){if($code=$("#sendValicode"),a.canSendCheckCode){var e=60;a.canSendCheckCode=!1,$code.addClass("wait").prop("disabled","disabled"),$code.text("等待"+e+"秒");var t=setInterval(function(){--e,0>=e?(clearInterval(t),a.canSendCheckCode=!0,$code.text("重新获取"),$code.removeClass("wait").removeAttr("disabled")):$code.text("等待"+e+"秒")},1e3)}},_loginFormValid:function(){var a=$("#validcode").val(),e=$("#phone").val(),t=!1,n=/^1\d{10}$/g;return e&&a?n.test(e)?t=!0:Popup.open("手机号输入有误！"):Popup.open("手机号、验证码均为必填项~"),t},_checkCodeAjax:function(a){var e=$("#phone").val(),t=$("#validcode").val();a.dialog.close(),$.ajax({url:a.urls.checkPhoneMes,type:"post",data:{sms_code:t,mobile:e,display:"json",share:"wxshare",openid:a.data.result.open_id},success:function(){location.reload()},error:function(){Popup.open("验证失败~")}})},eventHandle:function(){var a=this;Stat.addStat("SAK",{da_trd:"waimai",da_src:"activity.520couponding.click",da_act:"click"}),a._tipAnimation(),$("#music-btn").prop("disabled")||a._doGrab(),a._bearBigJump()},landscapeListen:function(){var a=$('[data-node="landscape"]');window.onorientationchange=function(){"-90"==window.orientation||"90"==window.orientation?a.removeClass("hide"):a.addClass("hide")}}})});