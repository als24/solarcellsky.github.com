!function(){function e(e,n){for(var t in n)e[t]=n[t];return e}var n="dpapp-share@~0.1.0",t="dpapp@1.1.21/lib/core.js",s="dpapp@1.1.21/lib/errortrace.js",i="dpapp@1.1.21/lib/patch-7.1.js",a="dpapp@1.1.21/lib/patch-7.0.js",o="dpapp@1.1.21/lib/web.js",c="dpapp@1.1.21/lib/patch-6.x.js",r="dpapp-core@^1.1.1",p="mix@^1.0.1",u="dpapp@1.1.21/lib/apis.js",d="dpapp@1.1.21/lib/async.js",l="dpapp@1.1.21/index.js",f=[n],h={"dpapp-share":n},m=h;define(l,[t,s,i,a,o,c],function(e,n,t,s,i){!function(n){var s=n.navigator.userAgent,i=e("./lib/core");e("./lib/errortrace"),i.patchForType("7.1.x",e("./lib/patch-7.1")),i.patchForType("7.0.x",e("./lib/patch-7.0"));var a="6.9.x"==i.getTypeFromUA(s);if(a){var o=i.getQuery();"!"==o.cityid?i.patchForType("6.9.x",e("./lib/web")):i.ready=function(n){var t=this._cfg,s=function(){i._isReady=!0,n()};if(t.unsupportOldApp===!0)i.patchForType("6.9.x",e("./lib/web")),s();else{i._getEnv(function(){clearTimeout(a),console.log("patchForType 6.9.x"),i.patchForType("6.9.x",e("./lib/patch-6.x")),s()});var a=setTimeout(function(){console.log("patchForType web"),i.patchForType("6.9.x",e("./lib/web")),delete i.isStatusOK,delete i.did_handle_callback,s()},50)}}}"undefined"!=typeof t&&(t.exports=i),"undefined"!=typeof n&&(n.DPApp?i._mixin(n.DPApp,i):(n.DPApp=i,"android"==DPApp._osUA.name&&a&&(n.Efte=i)))}(this)},{asyncDeps:f,main:!0,map:e({"./lib/core":t,"./lib/errortrace":s,"./lib/patch-7.1":i,"./lib/patch-7.0":a,"./lib/web":o,"./lib/patch-6.x":c},m)}),define(t,[r,p,u],function(e,n,t,s,i){var a=e("dpapp-core"),o=e("mix"),c=function(){},r=t.exports=new a({hippoPrefix:"dpapp",getTypeFromUA:function(e){return/dp\/com\.dianping/.test(e)?"7.1.x":/MApi/.test(e)?"7.0.x":"6.9.x"},apis:e("./apis"),allowBeforeReady:["getRequestId"],isOldVersion:function(){return"6.9.x"==this.uaType()},cache:{},Share:{WECHAT_FRIENDS:0,WECHAT_TIMELINE:1,QQ:2,SMS:3,WEIBO:4,QZONE:5,EMAIL:6,COPY:7},_tidyUrlParams:function(e){var n=e.split("?"),t=n[1],s=[];return t?(t.split("&").forEach(function(e){var n=e.split("=")[0];/^(newtoken|token)$/.test(n)||s.push(e)}),[n[0],s.join("&")].join("?")):n[0]},_getEnv:function(e){var n=this;this._doSendMessage("getEnv",{},function(t){n.cache.env=t,e.call(this,t)})},isStatusOK:c,did_handle_callback:c});window.DPApp&&(r=o(window.DPApp,r))},{asyncDeps:f,map:e({"./apis":u},m)}),define(s,[],function(e,n,t,s,i){var a=window.onerror,o="http://114.80.165.63/broker-service/api/js";window.onerror=function(e,n,t,s,i){var c=encodeURIComponent,r=Date.now();(new Image).src=o+"?error="+c(e)+"&v=1&data="+c(i&&i.stack?i.stack:"")+"&url="+c(location.href)+"&file="+c(n)+"&line="+c(t)+"&col="+c(s)+"&timestamp="+r,a&&a(e,n,t,s,i)}},{asyncDeps:f,map:m}),define(i,[a,t],function(e,n,t,s,i){function a(e){var n="on"+b._captal(e);return"android"==l.osName&&"7.6.0"==l.appVersion&&/appear|disappear/.test(e)&&(n=e),n}var o={},c=e("./patch-7.0"),r=e("./core"),p=window,u=function(){},d=function(){var e=navigator.userAgent,n=e.match(/dp\/[\w\.\d]+\/([\d\.]+)/),t=n&&n[1],s=e.match(/dp\/(com\.dianping\.\w+)/),i=s&&s[1],a=e.match(/adapter\/([\d\.]+)/),o=a&&a[1];return function(e){var n=e&&e.success,s={platform:"dpapp",appName:"dianping",packageId:i,appVersion:t,osName:r._osUA.name,osVersion:r._osUA.version,adapterVersion:o};return n&&n(s),s}}(),l=d(),f=r.Semver.lt(l.adapterVersion||l.appVersion,"7.2.0"),h=r.Semver.gte(l.adapterVersion||l.appVersion,"7.6.0"),m=r.Semver.gte(l.adapterVersion||l.appVersion,"7.8.0"),v=r.Semver.gte(l.adapterVersion||l.appVersion,"7.9.1"),g=r.Semver.gte(l.adapterVersion||l.appVersion,"7.9.4"),_=r.Semver.gte(l.adapterVersion||l.appVersion,"7.9.6"),y=["appear","disappear","scroll"],b=t.exports={getUA:d,ready:function(e){var n=this;this._send("ready",{success:function(){n._isReady=!0,e()}})},share:function(e){e.feed=this._parseFeed(e.feed),e.url=this._tidyUrlParams(e.url),this._send("share",e)},initShare:function(e){var n=this;this.setRRButton({icon:"H5_Share",handle:function(){e.handle&&e.handle(),n.share({title:e.title,desc:e.desc,content:e.content,image:e.image,feed:e.feed,url:e.url,success:e.success,fail:e.fail})}})},_captal:function(e){return e.slice(0,1).toUpperCase()+e.slice(1)},subscribe:function(e){function n(e){o[c]&&o[c].length&&o[c].forEach(function(n){n&&n(e)})}function t(){s&&(p.DPApp&&(p.DPApp[a(c)]=n),e.success&&e.success())}var s,i=this,c=e.action,r=(e.success,e.handle);o[c]?(e.success&&e.success(),o[c].push(r)):(-1!=y.indexOf(c)&&h?(s="on"+i._captal(c),"scroll"==c?this._send(s,{success:t}):t()):this._send("subscribe",{action:c,success:e.success,handle:n}),o[c]=[r])},unsubscribe:function(e){function n(){a[p]=u}var t=e.action,s=e.success,i=e.handle,a=this,c=o[t]?o[t].indexOf(i):-1;if(-1!=c?(o[t].splice(c,1),s&&s(),o[t].length||(o[t]=null)):i||(o[t]=null),!o[t])if(-1!=y.indexOf(t)&&h){var r="off"+a._captal(t),p="on"+a._captal(t);"scroll"==t?this._send(r,{success:n}):n()}else this._send("unsubscribe",{action:t,success:s})},pay:c.pay,ajax:function(e){e=this._sanitizeAjaxOpts(e);var n=e.success;e.success=function(t){var s=JSON.parse(t.mapiResult);s=this._transModel(e.keys,s),n(s)},this._send("mapi",e)},uploadImage:c.uploadImage,openScheme:function(e){var n=e.url,t=e.extra;t&&(n+="?"+this._convertUrlParams(t),delete e.extra,e.url=n),this._send("openScheme",e)},jumpToScheme:f?r._notImplemented:function(e){var n=e.url,t=e.extra;t&&(n+="?"+this._convertUrlParams(t),delete e.extra,e.url=n),e.toHome=e.toHome?1:0,this._send("jumpToScheme",e)},_getBizName:function(e,n){var t=e.fail,s=this._cfg.bizname;return s?s:(t&&t("use `DPApp.config({bizname:'<your-bizname>'})` first"),!1)},store:f?r._notImplemented:function(e){var n=this._getBizName(e);n&&(e.key=n+":"+e.key,this._send("store",e))},_loopGetUserInfo:function(e,n){function t(){s.getUserInfo({success:function(s){s.token?e&&e(s):i>5?n&&n():(i++,setTimeout(function(){t()},100))}})}var s=this,i=0;t()},updateAccount:function(e){e=e||{};var n=this,t=document.cookie.match(/dper=\w+/);return t&&(t=t[0].split("=")[1]),e.dper&&(t=e.dper),t?void n.ajax({url:"http://m.api.dianping.com/mlogin/convertdper.api",data:{dper:t},keys:["Token","NewToken"],success:function(t){var s=n.getUA();n.Semver.gte(s.appVersion,"7.5.0")?n._send("updateAccount",{token:t.Token,newtoken:t.NewToken,success:function(){n.getUserInfo({success:e.success})},fail:e.fail}):(n._send("loginsuccess",{token:t.Token,newtoken:t.NewToken}),n._loopGetUserInfo(e.success,e.fail))},fail:e.fail}):e.fail&&e.fail("Missing dper")},retrieve:f?r._notImplemented:function(e){var n=this._getBizName(e);n&&(e.key=n+":"+e.key,this._send("retrieve",e))},chooseImage:function(e){e=e||{},e.count=!e.count||e.count>9||e.count<1?9:e.count,this._send("chooseImage",e)},publish:function(e){if(f)return this._send("publish",e);var n=this._getBizName(e),t=["phoneChanged","AccountBindChange"];n&&(-1==t.indexOf(e.action)&&(e.action=n+":"+e.action),this._send("publish",e))},prompt:function(e){e.placeholder||(e.placeholder=""),this._send("prompt",e)},login:function(e){function n(e){s.getUserInfo({success:e})}var t,s=this;s.getUA();n(function(i){if(i.token)e.success&&e.success(i);else{var a="loginSuccess",o="appear",c=function(e){n(function(e){t=e}),s.unsubscribe({action:a,handle:c})};s.subscribe({action:a,handle:c});var r=function(){n(function(n){n&&n.token?e.success&&e.success(n):e.fail&&e.fail()}),s.unsubscribe({action:o,handle:r})};s.subscribe({action:o,handle:r}),s.openScheme({url:"dianping://login"})}})},getCity:function(e){this._send("getCityId",e)},setSpotlight:function(e){e.webpageURL&&(e.scheme||(e.scheme="dianping://web?url="+encodeURIComponent(e.webpageURL)),this._send("setSpotlight",e))},logout:function(e){var n;1===e.type?n="dianping://me":2===e.type&&(n="dianping://home"),n&&(e.success=function(){this.openScheme({url:n})}),this._send("logout",e)}};m||(b.alert=b.confirm=b.actionSheet=b.prompt=r._notImplemented),v||(b.setNavigationBarHidden=r._notImplemented),g||(b.playVoice=r._notImplemented,b.previewImage=r._notImplemented,b.setSpotlight=r._notImplemented),_||(b.logout=r._notImplemented),h?y.forEach(function(e){b[a(e)]=u}):b.isInstalledApp=r._notImplemented},{asyncDeps:f,map:e({"./patch-7.0":a,"./core":t},m)}),define(a,[p,c,t,u,d],function(e,n,t,s,i){var a=e("mix"),o=a({},e("./patch-6.x")),c=e("./core"),r=e("./apis"),p=e("./async"),u=t.exports=a(o,{getUA:function(e){var n=e&&e.success,t=navigator.userAgent.match(/MApi\s[\w\.]+\s\([\w\.\d]+\s([\d\.]+)/)[1],s={platform:"dpapp",appName:"dianping",appVersion:t,osName:this._osUA.name,osVersion:this._osUA.version};return n&&n(s),s},ready:function(e){e(),this._isReady=!0},Share:c.Share,pay:function(e){function n(e,n){DPApp.ajax({url:"http://api.p.dianping.com/payorder.pay",data:e,keys:["Content"],success:function(e){n(null,e)},fail:function(e){n("fail payorder")}})}function t(e){var n=7,t="5:1:null#219#0",s="11:1:null#217#0";return e==n?paymentTool=s:paymentTool=t,paymentTool}var s=this,i=e.payType,a=e.success,o=e.fail,c=e.cx;n({token:e.token,orderid:e.orderId,paymenttool:t(i),cx:c},function(e,n){return e?o&&o(e):void s._sendMessage("pay",{paytype:i,paycontent:n.Content},function(e){e.payresult?a&&a(e):o&&o(e)})})},uploadImage:function(e){var n=e.success,t=e.fail,s=e.handle,i=this.getUA(),a=this;e.localId||e.localIds?c.Semver.gte(i.adapterVersion||i.appVersion,"7.9.1")?e.localIds?!function(e){var s={};p.mapSeries(e,function(e,n){a._send("uploadPhoto",{localId:e,success:function(t){s[e]=t.picKey,n(null)},fail:function(e){n(e)}})},function(e){e?t&&t(e):n&&n({picKeys:s})})}(e.localIds):this._send("uploadPhoto",e):t({errMsg:"ERR_NOT_IMPLEMENTED"}):this._sendMessage("uploadImage",e,function(e){var n=e.status;return"fail"==n?void(t&&t(e)):void(s&&s(e))})},closeWindow:function(){this._sendMessage("close_web")}});r.forEach(function(e){u.hasOwnProperty(e)||(u[e]=c._notImplemented)})},{asyncDeps:f,map:e({"./patch-6.x":c,"./core":t,"./apis":u,"./async":d},m)}),define(o,[p,t,u],function(e,n,t,s,i){function a(e){return function(n){var t=JSON.stringify(n),s=n.success,i=n.fail,a=n.handle,o=document.createElement("script"),c="jsonp_callback"+h;h++,o.src="http://localhost:1943/?method="+e+"&params="+encodeURIComponent(t)+"&callback="+c,window[c]=function(e){var n=e.status;"success"==n?s&&s(e):"action"==n?a&&a(e):i&&i(e)},document.body.appendChild(o)}}var o=e("mix"),c=e("./core"),r=e("./apis"),p={},u="webkitvisibilitychange",d="scroll";o(p,{getUA:function(e){var n=e&&e.success,t={platform:"web",appName:null,appVersion:null,osName:this._osUA.name,osVersion:this._osUA.version};return n&&n(t),t},ready:function(e){var n=this,t=/complete|loaded|interactive/;t.test(document.readyState)&&document.body?(n._isReady=!0,e()):document.addEventListener("DOMContentLoaded",function(){n._isReady=!0,e()},!1)},ajax:function(e){function n(e){var n="";for(var t in e)n+=t+"="+encodeURIComponent(e[t]);return n}var t="GET",s=e.url,i=(e.method||t).toUpperCase(),a=e.headers||{},o=e.data,c=e.success,r=e.fail,p=new XMLHttpRequest;s||(s=location.href.split("?")[0]),i===t&&o&&(s+=n(o),o=null),i!==t&&p.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),p.onreadystatechange=function(){if(4==p.readyState){p.onreadystatechange=function(){};var e,n=!1;if(p.status>=200&&p.status<300||304==p.status){e=p.responseText;try{e=/^\s*$/.test(e)?null:JSON.parse(e)}catch(t){n=t}n?r&&r("ERR_PARSE_JSON"):c(e)}else r&&r(p.statusText)}},p.open(e.method,s,!0,e.username,e.password);for(var u in a)p.setRequestHeader(u,a[u]);p.send(o)},closeWindow:function(){window.close()}}),o(p,{getLocation:function(e){var n=e.success,t=e.fail;navigator.geolocation.getCurrentPosition(function(e){n&&n({lat:e.coords.latitude,lng:e.coords.longitude})},function(){t&&t("ERR_GET_LOCATION")})},getCityId:function(e){var n,t=function(e){return n||(n={},document.cookie.split(";").forEach(function(e){var t=e.trim().split("="),s=t[0],i=t[1];n[s]=i})),n[e]},s=t("cy")||t("cityid");s||(s=null),e&&e.success&&e.success({cityId:s})},getCity:function(e){return this.getCityId(e)}}),o(p,{pay:function(e){},share:function(n){var t=n.success,s=(n.handle,n.title),i=n.desc,a=n.content,o=n.image,c=n.url;e.async("dpapp-share",function(e){e.pop({title:s,desc:i,content:a,pic:o,url:c}),t&&t()})}}),o(p,{setTitle:function(e){var n=e.title;n&&(document.title=n),e.success&&e.success()}});var l={};o(p,{subscribe:function(e){var n=this,t=e.action,s=e.success,i=e.handle,a=e.fail;return t&&i?(l[t]?l[t].push(i):l[t]=[i],t==d&&window.addEventListener(d,n._scrollEvent),"appear"==t&&document.addEventListener(u,n._appearEvent),"disappear"==t&&document.addEventListener(u,n._disappearEvent),void(s&&s())):void(a&&a("missing params"))},_appearEvent:function(){0==document.hidden&&DPApp.publish({action:"appear"})},_disappearEvent:function(){1==document.hidden&&DPApp.publish({action:"disappear"})},_scrollEvent:function(e){DPApp.publish({action:d,data:{offset:window.scrollY}})},unsubscribe:function(e){var n=e.action,t=e.success,s=e.handle,i=e.fail;if(!n)return void(i&&i("Missing params"));var a=l,o=a[n];if(!o)return void(t&&t());if(s){var c=o.indexOf(s);a[n]=o.splice(c,1)}else n==d&&window.removeEventListener(d,self._scrollEvent),delete a[n];t&&t()},openScheme:function(e){var n=document.createElement("iframe"),t=e.extra,s=e.url;t&&(s+="?"+this._convertUrlParams(t),delete e.extra),n.style.display="none",n.src=s,document.body.appendChild(n)},publish:function(e){if(e.action){var n=e.action,t=e.data,s=e.success,i=l[n];i&&i.forEach(function(e){e(t)}),s&&s()}}});var f=document.cookie.match(/dpapp-mocker=(\w+)/);f&&(f=f[1]);var h=1;r.forEach(function(e){"force"==f?p[e]=a(e):p.hasOwnProperty(e)||("patch"==f?p[e]=a(e):p[e]=c._notImplemented)}),t.exports=p},{asyncDeps:f,map:e({"./core":t,"./apis":u},m)}),define(c,[u,t],function(e,n,t,s,i){var a=function(){},o=e("./apis"),c=e("./core"),r=t.exports={_sendMessage:function(e,n,t){this._doSendMessage(e,n,t)},getUA:function(e){var n=e&&e.success,t=this.cache&&this.cache.env,s={platform:"dpapp",appName:"dianping",appVersion:t&&t.version,osName:this._osUA.name,osVersion:this._osUA.version};return n&&n(s),s},initShare:function(e){var n=e.success,t=e.fail,s="dpshare://_?content=";s+=encodeURIComponent(JSON.stringify({title:e.title,desc:e.desc,image:e.image,feed:this._parseFeed(e.feed),url:e.url})),this.shareCallback=function(e){"success"==e.status?n&&n(e):t&&t(e)},this._createIframe(s)},shareCallback:function(){},getCityId:function(e){var n=e.success;this._getEnv(function(e){n&&n({cityId:e.cityid})})},getNetworkType:function(e){var n=e.success;this._getEnv(function(e){n&&n({networkType:e.network})})},getUserInfo:function(e){var n=e.success;this._getEnv(function(e){n&&n({token:e.token,dpid:e.dpid,userId:e.userId})})},getVersion:function(e){var n=e.success;this._getEnv(function(e){console.log(JSON.stringify(e)),n&&n({version:e.version})})},getLocation:function(e){var n=e.success;this._getEnv(function(e){n&&n({lat:e.latitude,lng:e.longitude})})},getCX:function(e){var n=e.business,t=e.success;this._sendMessage("cx",{business:n},t)},closeWindow:function(){this._sendMessage("close_web")},setTitle:function(e){document.title=e.title;var n=e.success,t=e.title;this._sendMessage("setTitle",{title:t,success:n}),n&&n()},openScheme:function(e){var n=e.url,t=e.extra;t&&(n+="?"+this._convertUrlParams(t)),this._sendMessage("actionScheme",{url:n})},ajax:function(e){function n(e){var n={};if(e&&e.length>0)try{n=JSON.parse(e)}catch(t){}return n}e=this._sanitizeAjaxOpts(e);var t=e.success,s=e.fail;this._sendMessage("ajax",e,function(i){if(0==i.code){var a=this._mixin(n(i.responseText),this._transModel(e.keys,n(i.hashJson)));t&&t(a)}else s&&s({code:i.code,errMsg:i.message})})},ready:function(e){var n=this;this._getEnv(function(){n._isReady=!0,e.call(n)})},_parseFeed:function(e){var n;return e?e.constructor.toString().indexOf("Array")>=0?(n=[0,0,0,0,0,0,0,0],e.forEach(function(e){n[e]=1}),parseInt(n.join(""),2)):void 0:255},share:function(e){e.feed=this._parseFeed(e.feed),opt.url=this._tidyUrlParams(opt.url),this._sendMessage("share",e)},isStatusOK:a,did_handle_callback:a};o.forEach(function(e){r.hasOwnProperty(e)||(r[e]=c._notImplemented)})},{asyncDeps:f,map:e({"./apis":u,"./core":t},m)}),define(u,[],function(e,n,t,s,i){t.exports=["getRequestId","isInstalledApp","getNetworkType","getVersion","getUserInfo","login","updateAccount","logout","getCityId","getLocation","getCity","setPullDown","stopPullDown","openScheme","jumpToScheme","closeWindow","getContactList","sendSMS","ajax","setSpotlight","store","retrieve","downloadImage","chooseImage","previewImage","playVoice","share","publish","subscribe","unsubscribe","alert","prompt","confirm","actionSheet","setTitle","setBackgroundColor","setNavigationBarHidden","setLLButton","setLRButton","setRLButton","setRRButton","getCX"]},{asyncDeps:f,map:m}),define(d,[],function(e,n,t,s,i){n.mapSeries=function(e,n,t){function s(c,r){return c?t(c):(a++,o.push(r),void(a!==i?n(e[a],s):t(null,o)))}var i=e.length,a=0,o=[];n(e[a],s)}},{asyncDeps:f,map:m})}();
//# sourceMappingURL=dpapp.js.map