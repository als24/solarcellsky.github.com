var LoadingUI=function(t){function i(){t.call(this),this.createView()}__extends(i,t);var e=(__define,i),s=e.prototype;return s.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},s.setProgress=function(t,i){this.textField.text="Loading..."+t+"/"+i},i}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(t){function i(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(i,t);var e=(__define,i),s=e.prototype;return s.onAddToStage=function(t){RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},s.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},s.onResourceLoadComplete=function(t){"preload"==t.groupName&&(RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.stage.addChild(new Game),this.stage.removeChild(this))},s.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},s.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},s.onResourceProgress=function(t){"preload"==t.groupName},i}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");var Ball=function(t){function i(i){t.call(this),this.bIsPause=!1,this.bIsRandom=!1,this.playerList=i.playerList,this._parent=i,this.addEventListener(egret.Event.ADDED_TO_STAGE,this.initView,this)}__extends(i,t);var e=(__define,i),s=e.prototype;return s.initView=function(){this.height=20,this.width=20,this.reset(1);var t=new egret.Shape;t.graphics.beginFill(16777215),t.graphics.drawRect(0,0,this.width,this.height),t.graphics.endFill(),this.addChild(t)},s.pause=function(){console.log("pause"),this.bIsPause=!0},s.resume=function(){console.log("resume"),this.bIsPause=!1},s.stop=function(){console.log("stop"),egret.stopTick(this._move,this)},s.reset=function(t){this.x=(this.parent.width-this.width)/2,this.y=(this.parent.height-this.height)/2;var i=t?60*Math.random()-30:60*Math.random()+150;return i=i/180*Math.PI,this.vx=window.config.ballSpeed*Math.cos(i),this.vy=window.config.ballSpeed*Math.sin(i),this},s.move=function(){egret.startTick(this._move,this)},s.randomMove=function(){this.bIsRandom=!0,this.move()},s._move=function(){return this.bIsPause?!1:(this.x+=this.vx,this.y+=this.vy,this.y<0?(this.vy*=-1,this.y=0,this.playSound("bounds")):this.y>this.parent.height-this.height&&(this.vy*=-1,this.y=this.parent.height-this.height,this.playSound("bounds")),this.bIsRandom?this.x<0?(this.vx*=-1,this.x=0,this.playSound("bounds")):this.x>this.parent.width-this.width&&(this.vx*=-1,this.x=this.parent.width-this.width,this.playSound("bounds")):(this.x<0?(this.pause(),this.reset(0),this._parent.goal(1)):this.x>this.parent.width&&(this.pause(),this.reset(1),this._parent.goal(0)),this.x<this.playerList[0].width?this.checkHit(this.playerList[0],0):this.x>this.parent.width-this.playerList[1].width&&this.checkHit(this.playerList[1],1)),!0)},s.checkHit=function(t,i){if(t.y>this.y&&t.y<this.y+this.height||this.y>t.y&&this.y<t.y+t.height){this.x=i?this.parent.width-t.width:t.width;var e=this.y>t.y?this.y:this.y+this.height,s=(e-t.y-t.height/2)/t.height*2*window.config.dAngle;1===i&&(s=180-s),console.log(e,(e-t.y-t.height/2)/t.height*2,s,i),s=s/180*Math.PI,this.vx=window.config.ballSpeed*Math.cos(s),this.vy=window.config.ballSpeed*Math.sin(s),this.playSound("board")}},s.playSound=function(t){var i="board"==t?"duang2_wav":"duang1_wav";RES.getRes(i).play(0,1)},i}(egret.Sprite);egret.registerClass(Ball,"Ball");var log=egret.log,Game=function(t){function i(){t.call(this),this.playerList=[],this.score=[0,0],this.addEventListener(egret.Event.ADDED_TO_STAGE,this.initView,this),this.initSoc()}__extends(i,t);var e=(__define,i),s=e.prototype;return s.initSoc=function(){var t=this.soc=io.connect("http://"+window.config.host+":"+window.config.port+"/screen"),i=this;t.on("connect",function(){log("SOC connect"),i.test.call(i)}),t.on("rid",function(t){t.rid&&i.showQRcode.call(i,t.rid)}),t.on("gameStart",function(){i.gameStart.call(i)}),t.on("playerJoin",function(t){i.playerJoin.call(i,t)}),t.on("move",function(t){var e=i.playerList[t.playerNo];Date.now();e&&e.move(t)}),t.on("disconnect",function(){})},s.initView=function(){var t=this.ground=new Ground;this.addChild(t),t.x=(this.stage.stageWidth-t.width)/2,t.y=(this.stage.stageHeight-t.height)/2;var i=this.palyerContainer=new egret.DisplayObjectContainer;i.width=t.width,i.height=t.height,i.x=t.x,i.y=t.y,this.addChild(i);var e=this.ball=new Ball(this);e.randomMove(),t.addChild(e);var s=this.pScore0=new egret.BitmapText,h=this.pScore1=new egret.BitmapText;s.font=h.font=RES.getRes("myFont_fnt"),s.y=h.y=t.y+40,h.x=this.stage.stageWidth/2+80,s.x=this.stage.stageWidth/2-s.width-80,s.visible=h.visible=!1,this.addChild(s),this.addChild(h);var n=this.panel=new egret.DisplayObjectContainer;n.width=850,n.height=630,n.x=180,n.y=t.y+40,this.addChild(n);var r=new egret.Bitmap(RES.getRes("logo_png"));r.x=(n.width-r.width)/2,n.addChild(r);var o=this.playerContainer=new egret.DisplayObjectContainer;o.width=600,o.height=238,o.x=(n.width-o.width)/2,o.y=r.height+120,n.addChild(o);var a=this.p1bg=new egret.Bitmap(RES.getRes("p1bg_png"));o.addChild(a);var d=this.p2bg=new egret.Bitmap(RES.getRes("p2bg_png"));d.x=o.width-d.width,o.addChild(d);var l=this.vs=new egret.Bitmap(RES.getRes("vs_png"));l.x=(o.width-l.width)/2,l.y=55,o.addChild(l);var g=this.p1Avt=new egret.Bitmap,c=this.p2Avt=new egret.Bitmap;o.addChild(g),o.addChild(c),this.setPlayerAvt(1,"nop"),this.setPlayerAvt(2,"nop");var p=new egret.Bitmap(RES.getRes("cp_png"));p.x=(n.width-p.width)/2,p.y=n.height,n.addChild(p);var v=this.win=new egret.Bitmap(RES.getRes("win_png"));v.y=(t.height-v.height)/2,v.visible=!1,t.addChild(v)},s.showQRcode=function(t){window.makeQRcode(t,function(t){var i=this.qrCode=new egret.Bitmap;i.texture=t,i.x=this.stage.stageWidth/2+150,i.y=this.ground.y+40,this.addChild(i)},this)},s.setPlayerAvt=function(t,i){var e=this["p"+t+"Avt"];e&&(e.texture=RES.getRes(i+"_png"),"nop"==i?e.y=55:e.y=37,e.x=this["p"+t+"bg"].x+(this["p"+t+"bg"].width-e.width)/2)},s.updateScore=function(){this.pScore1.text=""+this.score[1],this.pScore0.text=""+this.score[0],this.pScore0.x=this.stage.stageWidth/2-this.pScore0.width-80,this.pScore0.visible=this.pScore1.visible=!0},s.test=function(){},s.goal=function(t){if(console.log(t?"右边的朋友得分了":"左边的朋友得分了"),RES.getRes("fail_wav").play(0,1),this.score[t]++,this.updateScore(),this.score[t]>=window.config.winScore)return void this.gameOver(t);var i=this;setTimeout(function(){i.ball.resume.call(i.ball)},2e3)},s.gameStart=function(){log("gameStart"),this.countDown(function(){this.qrCode.visible=this.panel.visible=!1,this.ground.showBorders(),this.updateScore(),this.ball.pause(),this.ball.reset(),this.ball.bIsRandom=!1;var t=this;setTimeout(function(){t.ball.resume.call(t.ball)},2e3)})},s.countDown=function(t){function i(){s%2?n.vs.visible=!1:n.vs.visible=!0,s--<0?(n.vs.visible=!1,a.visible=!0,e()):setTimeout(i,r)}function e(){h--,console.log(h),h>-1?(a.text=""+h,a.x=(n.playerContainer.width-a.width/2)/2,setTimeout(e,o)):(n.playerContainer.removeChild(a),t&&t.call(n))}var s=6,h=0+window.config.coundown,n=this,r=100,o=1e3;i();var a=new egret.BitmapText;a.font=RES.getRes("myFont_fnt"),a.visible=!1,a.y=40,a.letterSpacing=10,a.scaleX=a.scaleY=.5,this.playerContainer.addChild(a)},s.playerJoin=function(t){var i=this.playerList.length;if(2>i){var e=new Player(t);e.name="player",this.playerList.push(e),this.palyerContainer.addChild(e);var s=i+1;this.setPlayerAvt(s,"p"+s)}},s.gameOver=function(t){console.log("gameover",t),RES.getRes("win_mp3").play(0,1),this.win.x=this.ground.width/2+(t?100:-this.win.width-100),this.win.visible=!0,this.soc.emit("gameOver",{winner:t});var i=this;setTimeout(function(){i.reset.call(i)},1e3*window.config.winPanelDuration)},s.reset=function(){this.win.visible=!1,this.score=[0,0],this.ground.hideBorders(),this.panel.visible=!0,this.pScore0.visible=this.pScore1.visible=!1,this.ball.randomMove(),this.ball.resume(),this.qrCode.visible=!0,this.vs.visible=!0,this.playerList.length=0,this.palyerContainer.removeChildren(),this.setPlayerAvt(2,"nop"),this.setPlayerAvt(1,"nop")},i}(egret.DisplayObjectContainer);egret.registerClass(Game,"Game");var Ground=function(t){function i(){t.call(this),this.width=1800,this.height=900,this.addEventListener(egret.Event.ADDED_TO_STAGE,this.initView,this)}__extends(i,t);var e=(__define,i),s=e.prototype;return s.initView=function(){var t=20,i=this.lineT=new egret.Shape;i.graphics.beginFill(16777215),i.graphics.drawRect(0,-t,this.width,t),i.graphics.endFill(),this.addChild(i);var e=this.lineB=new egret.Shape;e.graphics.beginFill(16777215),e.graphics.drawRect(0,this.height,this.width,t),e.graphics.endFill(),this.addChild(e);var s=this.midLine=new egret.Shape;s.graphics.beginFill(16777215),s.graphics.drawRect(this.width/2-1,0,2,this.height),s.graphics.endFill(),this.addChild(s),s.visible=i.visible=e.visible=!1},s.showBorders=function(){this.midLine.visible=this.lineB.visible=this.lineT.visible=!0},s.hideBorders=function(){this.midLine.visible=this.lineB.visible=this.lineT.visible=!1},i}(egret.DisplayObjectContainer);egret.registerClass(Ground,"Ground");var Player=function(t){function i(i){t.call(this),this.data=i,this.addEventListener(egret.Event.ADDED_TO_STAGE,this.initView,this)}__extends(i,t);var e=(__define,i),s=e.prototype;return s.initView=function(){this.width=20,this.height=window.config.boardHeight||200;var t=new egret.Shape;t.graphics.beginFill(16777215),t.graphics.drawRect(0,0,this.width,this.height),t.graphics.endFill(),this.addChild(t),this.x=this.data.playerNo?this.parent.width-this.width:0,this.y=(this.parent.height-this.height)/2},s.move=function(t){var i=this.y+t.dy*window.config.borderSpeed;i=Math.max(i,0),i=Math.min(i,this.parent.height-this.height),this.y=i},i}(egret.Sprite);egret.registerClass(Player,"Player");