var DCAgentInitConfig=function(){},DCAgentPaymentConfig=function(){};!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("DCAgent",["exports"],t):t(e.DCAgent={})}(this,function(e){function t(e){return"undefined"!=typeof J[e]}function n(){}function r(e){return"function"==typeof e}function a(e){var t,n;return t=Date.now(),n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n;return n=(t+16*Math.random())%16|0,t=Math.floor(t/16),"x"===e?n.toString(16):(7&n|8).toString(16)}),(e||"")+n.replace(/-/g,"").toUpperCase()}function o(e){var t,n;for(t in e)n=e[t],e[t]=n;return(2<=arguments.length?[].slice.call(arguments,1):[]).forEach(function(r){var a;a=[];for(t in r)n=r[t],a.push(e[t]=n);return a}),e}function i(e,t,n){if(r(e))try{return e.apply(t,n)}catch(a){u("attemp error for "+e.toString(),a.stack)}}function c(e,t,n){function r(){!1!==i(e)&&tt(r,t)}n?r():tt(r,t)}function u(e,t){console.log("#DCAgent: "+e),t&&console.log(t)}function s(e){try{return e.setItem(".","."),e.removeItem("."),!0}catch(t){return!1}}function l(e){return e?(e=e.match(/^(https?\:)\/\/(([^:\/?#]*)(?:\:([0-9]+))?)(\/[^?#]*)(\?[^#]*|)(#.*|)$/))&&e[3]:""}function d(e,t){return e=g(e),ot.setItem(e,t),Ct.set(e,t,365),t}function f(e){return e=g(e),ot.getItem(e)||Ct.get(e)}function g(e){return $||St===e?e:(z.appId||u("appid should not be empty when you are in native env"),z.appId+"."+e)}function p(e){var t=V.hash,n="!"+e;if(t){var r=/![0-9A-Z]{32,128}/gi;(t=t.match(r))?(t=t[0].slice(1),e===t||f(pt)||(z.parentId=t,d(pt,t)),e=V.href.replace(r,n),V.replace(e)):V.replace(V.href+n)}else V.replace(V.href+"#"+n)}function m(e){e=g(e);try{var t=JSON.parse(ot.getItem(e));return Array.isArray(t)?t:[]}catch(n){return ot.removeItem(e),[]}}function y(e,t){var n=m(t);Array.isArray(e)?e.forEach(function(e){return n.push(e)}):n.push(e),ot.setItem(g(t),JSON.stringify(n))}function v(){ot.removeItem(g(mt)),ot.removeItem(g(yt))}function h(){J.addEventListener&&J.addEventListener("error",function(e){i(function(){if(Rt.isReportAllowed(e.filename)){Rt.count+=1;var t={};["colno","filename","lineno","message"].forEach(function(n){return t[n]=e[n]||"1"});var n=e.error||{};if(t.stack=encodeURIComponent(n.stack||n.stacktrace||""),t.type=n.name||"Error",t.timestamp=parseInt(e.timeStamp/1e3),r(z.getErrorScene)&&(n=i(z.getErrorScene,n,[e]))){if(n&&"[object Object]"===nt.call(n)){var a,o="";for(a in n)o+="	"+a+"="+n[a]+"\n";n=o}else n=String(n);t.stack+="\n\nError scene:\n"+encodeURIComponent(n)}Dt.updateStorageByKey(t,yt)}})},!1)}function S(){if(Mt)return Mt;if(kt+=1,!(kt>4)){var e,t={egret:"egret",layabox:"layabox",cocos:"cc.game",impact:"ig",phaser:"Phaser",pixi:"PIXI",create:"createjs",three:"THREE",gameMaker:"asset_get_type",playCanvas:"pc.fw",turbulenz:"TurbulenzEngine",quintus:"Quintus",melon:"me.game",lychee:"lychee",wade:"wade.addSceneObject",crafty:"Crafty",lime:"lime.Scene",enchant:"enchant",isogenic:"IgeEngine",gameclosure:"GC.Application",panda:"game.Scene",kiwi:"Kiwi",jaws:"jaws",sirius2d:"ss2d",collie:"collie",physics:"Physics",stage:"Stage.Anim",babylon:"BABYLON"};for(e in t){var n=t[e];if(-1<n.indexOf(".")){var n=n.split("."),r=J[n[0]];if(r&&r[n[1]])return Mt=e}else if(J[n])return Mt=e}}}function b(){var e;return Nt||(Nt={appid:z.appId,accountid:z.accountId,uid:z.deviceId,appver:z.appVer,ver:Tt,channel:z.channel,domain:K.domain||"",screen:Pt,logintime:String(parseInt(z.loginTime/1e3)),crtime:f(ut)||""}),e=Nt,e.onlinetime=String(z.intervalCount*z.interval/1e3||1),e.pv="0",e.engine=S()||"",e}function x(e){return 0>e?wt:Math.min(e,wt)}function I(e){var t=qt();t.timeout=wt,t.open("POST",e.url,!0),t.setRequestHeader("Content-Type","text/plain; charset=UTF-8");var n=Date.now();t.onreadystatechange=function(){if(4===this.readyState){var t="success"===this.responseText,r=x(Date.now()-n);i(t?e.success:e.error,this,[this,r]),i(e.complete,this,[this,r]),this.ontimeout=this.onreadystatechange=null}},t.ontimeout=function(){var t=x(Date.now()-n);i(e.error,this,[this,t,!0]),i(e.complete,this,[this,t]),this.ontimeout=this.onreadystatechange=null},t.send(JSON.stringify(e.data))}function w(e){var t=new egret.URLLoader,n=Date.now();t.addEventListener(egret.Event.COMPLETE,function(t){var r=x(Date.now()-n);t=t.target,i("success"===t.data?e.success:e.error,t,[t,r,r>=wt]),i(e.complete,t,[t,r])});var r=new egret.URLRequest(e.url);r.method=egret.URLRequestMethod.POST,r.data=JSON.stringify(e.data),t.load(r)}function O(e,t){if(e.data){e.data.errors&&e.data.errors.length>Rt.max&&(z.debug&&u("sending too many errors, only "+Rt.max+" allowed"),e.data.errors=e.data.errors.slice(0,Rt.max));for(var n in e.data)"number"==typeof e.data[n]&&(e.data[n]=String(e.data[n]));n=Math.abs(z.onlinetime),n>Et||0>=n?z.debug&&u("illegal online time: "+n):(n=o({headers:b()},e.data),Bt({url:t,data:n,success:function(t,n){Ut.succ=1,Ut.fail=0,Ut.total=n,i(e.success,t,[t,n])},error:function(t,n,r){Ut.succ=0,Ut.fail+=1,Ut.total+=n,i(e.error,t,[t,n,r]),r&&z.debug&&u("report timeout, network infomation",Ut)},complete:function(t,n){Dt.updateStorageByKey({eventid:It,labelmap:JSON.stringify(Ut),duration:"1"},mt),i(e.complete,t,[t,n])}}),z.debug&&u("report data:",n))}}function E(e,t,n,r){var a={data:{online:{},events:e||[],errors:t||[]},success:r};n&&(a.data.reg=n),e=Dt.getStorageByKey(mt),t=Dt.getStorageByKey(yt),(e.length||t.length)&&(Dt.clear(),a.data.events=a.data.events.concat(e),a.data.errors=a.data.errors.concat(t),a.error=function(){z.debug&&u("report failed, restoring data to localStorage"),Dt.updateStorageByKey(a.data.events,mt),Dt.updateStorageByKey(a.data.errors,yt)}),O(a,bt)}function C(e,t,n){e={page:encodeURIComponent(e||Ht),optime:parseInt(z.initializedOn),ottime:parseInt(Date.now()/1e3),lttime:parseInt(z.loginTime/1e3)},E([{eventid:"_DESelf_PV",labelmap:JSON.stringify(e),duration:"1"}],null,t,n)}function A(){i(function(){if(J[Ot])J[Ot]=null;else if("function"==typeof define&&define.amd)require.undef(Ot);else if("object"==typeof e&&"undefined"!=typeof module){var t=require.resolve(Ot);delete require.cache[t]}else u("unknown module system, unload DCAgent manually please");u("DCAgent has been destroyed.")})}function j(){return Jt?(A(),!1):(rt&&K[rt]||(z.intervalCount+=1,it.setItem(g(ht),z.intervalCount),E()),!0)}function R(e,t){if(!Vt.isAgentReady()){var n=[e];return[].forEach.call(t,function(e){return n.push(e)}),zt.push(n),!0}}function D(e){e=g(e);try{var t=JSON.parse(ot.getItem(e));return Array.isArray(t)?t:[]}catch(n){return ot.removeItem(e),[]}}function T(e,t){var n=D(t);Array.isArray(e)?e.forEach(function(e){return n.push(e)}):n.push(e),ot.setItem(g(t),JSON.stringify(n))}function _(){ot.removeItem(g(mt)),ot.removeItem(g(yt))}function P(e,t,n){if(e){if(!R("onEvent",arguments)){(null==t||1>t)&&(t=1);var r;if(n&&"[object Object]"===nt.call(n)){for(r in n)n[r.replace("%","_")]=encodeURIComponent(n[r]);r=JSON.stringify(n)}else r="";Gt.updateStorageByKey({eventid:e,duration:String(t),labelmap:r},mt)}}else u("invoke failed, missing eventId")}function L(e){R("onPageView",arguments)||C(e)}function M(e){e&&e.hasOwnProperty("amount")&&!R("onPayment",arguments)&&(e.amount=parseFloat(e.amount)||0,O({data:{payment:{currencyAmount:e.amount.toFixed(2),currencyType:e.currencyType||"CNY",payType:String(e.payType||""),iapid:String(e.iapid||""),orderId:String(e.orderId||""),payTime:String(e.payTime||"")}}},bt))}function N(e,t,n,a){t&&d(St,e),z.deviceId=e,z.accountId=z.accountId||e;var o=it.getItem(g(vt));for(o||(o=Date.now(),it.setItem(g(vt),o)),z.loginTime=o,o=it.getItem(g(ht)),o||(o="0",it.setItem(g(ht),o)),z.intervalCount=parseInt(o),z.interval=1e3*Math.max(10,parseFloat(n.interval||z.interval)),z.virus&&At(e),z.errorReport&&(n.excludes&&(Rt.excludes=Rt.excludes.concat(n.excludes)),h()),n=null,t&&(n={isact:t,isreg:1},z.parentId&&(n.parentid=z.parentId),G.localStorage||(n.localstorage=1)),z.initializedOn=Date.now()/1e3,f(ut)||d(ut,z.initializedOn),C(null,n),Vt.setReadyState(3),t={onEvent:P,onPageView:L,onPayment:M},n=0,o=zt.length;o>n;n++){var i=zt[n];t[i.shift()].apply(J,i)}zt.length=0,c(j,z.interval),r(a)&&a(e)}function k(e){function t(n){i(function(){if(0===xt.indexOf(n.origin)){var r=JSON.parse(n.data);J.removeEventListener("message",t,!1),d(ut,r.crtime),e(r.id)}})}J.addEventListener("message",t,!1);var n=!1,r=Date.now(),a=K.createElement("iframe");tt(function(){if(!n){var o=Date.now()-r;a.onload=null,a.parentNode.removeChild(a),J.removeEventListener("message",t,!1),d(ut,parseInt(Date.now()/1e3)),Gt.updateStorageByKey({eventid:"WHOAMI_TIMEOUT",duration:"1",labelmap:{elapsed:o}},mt),U(e)}},1e4),a.style.display="none",a.src=xt,a.onload=function(){n=!0,this.onload=null,this.parentNode.removeChild(this)};var o=function(){return K.body.appendChild(a)};K.body?o():K.addEventListener("DOMContentLoaded",o,!1)}function U(e){if(d(ut,parseInt(Date.now()/1e3)),G.engine.layabox){var t=layabox.getDeviceInfo()||{},n=t.mac||t.idfa||a(q()),n=n.replace(/[-_:=\s]+/g,"").toUpperCase();if(32>n.length){for(var t=n,n=Math.ceil(32-n.length)/2,n=void 0===n?0:n,r="",o=0;n>o;o+=1)r+="0A";n=t+r}e(n)}else e(a(q()))}function q(){return G.engine.egret?st+lt:G.engine.layabox?st+dt:G.engine.cocos?st+ft:st+gt}var B,H=(0,eval)("this"),J=H||{},K=H.document||{},V=H.location||{},z={appId:"",deviceId:"",accountId:"",channel:"",appVer:"",interval:10,intervalCount:0,loginTime:0,debug:J.DCAGENT_DEBUG_OPEN},G={get engine(){return Q},get localStorage(){return Z},get sessionStorage(){return Y},get postMessage(){return W},get realBrowser(){return $},get cookie(){return et}};if("function"==typeof K.createElement){var X=K.createElement("div");if(X&&"function"==typeof X.querySelector){X.innerHTML="<i></i>";var F=X.querySelector("i");B=!!F&&"I"===F.tagName}}var Q={egret:t("egret"),layabox:t("layabox"),cocos:t("cc")},Z=!!J.localStorage||Q.egret||Q.cocos,Y=!!J.sessionStorage,W=!!J.postMessage,$=B,et=$&&"cookie"in K,tt=J.setTimeout;Q.egret&&(tt=function(e,t){egret.setTimeout(e,J,t)});var nt=Object.prototype.toString,rt="hidden"in K?"hidden":"webkitHidden"in K?"webkitHidden":"mozHidden"in K?"mozHidden":"msHidden"in K?"msHidden":null,at={getItem:n,setItem:n,removeItem:n},ot=G.localStorage?J.localStorage:at,it=G.sessionStorage?J.sessionStorage:at;G.engine.egret?ot=egret.localStorage:G.engine.cocos&&(ot=cc.sys.localStorage);var ct,ut="dcagent_create_time",st="ND",lt="EGRET",dt="LAYA",ft="COCOS",gt="UE",pt="dcagent_parent_id",mt="dcagent_client_events",yt="dcagent_client_errors",vt="dcagent_login_time",ht="dcagent_interval_key",St="dcagent_client_id",bt="http://rd.gdatacube.net/dc/html5/sync",xt="http://rd.gdatacube.net/dc/html5/whoami",It="_DESelf_OSS",wt=3e4,Ot="DCAgent",Et=172800,Ct=ct=G.cookie?{get:function(e){return(e=K.cookie.match(new RegExp("(^|)\\s*"+e+"=([^\\s]*)")))&&3<=e.length?decodeURIComponent(e[2]):null},set:function(e,t,n,r,a,o){var i;n&&(i=new Date,i.setTime(i.getTime()+864e5*n)),n=n?" expires="+i.toGMTString():"",a=" path="+(a||"/"),r=r?" domain="+r:"",o=o?" secure":"",K.cookie=e+"="+encodeURIComponent(t)+n+a+r+o},remove:function(e,t,n){ct.set(e,"",-1,t,n)}}:{get:n,set:n,remove:n},At=G.realBrowser?p:n,jt={max:100,count:0,excludes:[],isReportAllowed:function(e){return jt.count<jt.max?jt.excludes.every(function(t){return-1===e.indexOf(t)}):void 0}},Rt=jt,Dt={get getStorageByKey(){return m},get updateStorageByKey(){return y},get clear(){return v}},Tt="16";e.version=Tt;var _t=J.screen||{},Pt=_t.width&&_t.width+"*"+_t.height;if(!Pt){var Lt;G.engine.layabox?(Lt=layabox.getDeviceInfo()||{},Pt=Lt.resolution||"0*0"):G.engine.cocos?(Lt=cc.view.getViewPortRect()||{},Pt=Lt.width+"*"+Lt.height):Pt="0*0"}var Mt,Nt,kt=0,Ut={succ:0,fail:0,total:0},qt=function(){return new J.XMLHttpRequest},Bt=function(){return J.XMLHttpRequest?I:G.engine.cocos?(qt=function(){return cc.loader.getXMLHttpRequest()},I):G.engine.egret?w:(u("XMLHttpRequest not found"),n)}(),Ht=G.realBrowser?V.pathname+V.search:"/",Jt=!1;e.teardown=function(){Jt=!0};var Kt=0,Vt={getReadyState:function(){return Kt},setReadyState:function(e){Kt=e},isAgentReady:function(){return 3===Kt}},zt=[],Gt={get getStorageByKey(){return D},get updateStorageByKey(){return T},get clear(){return _}};e.onEvent=P,e.onPageView=L,e.onPayment=M;var Xt=G.postMessage&&G.realBrowser?k:U;e.init=function(e,t){if(s(ot))if(0<Vt.getReadyState())u("DCAgent.init should be called only once");else if(e=e||{},e.appId){["errorReport","virus"].forEach(function(t){return z[t]=e.hasOwnProperty(t)?!!e[t]:!0}),["appId","accountId","appVer","getErrorScene"].forEach(function(t){return z[t]=e[t]||""}),J.QZAppExternal&&J.QZAppExternal.getPlatform&&2==J.QZAppExternal.getPlatform()&&(u("virus disabled"),z.virus=!1),z.channel=e.channel||l(K.referrer);var n=f(St);n?N(n,0,e,t):(Vt.setReadyState(1),Xt(function(n){Vt.setReadyState(2),N(n,1,e,t)}))}else u("init failed, missing appId");else u(G.localStorage?"localstorage qouta error, private mode?":"localstorage is not supported.")};var Ft=Vt.isAgentReady;Object.defineProperty(e,"readyState",{get:function(){return u("DCAgent.readyState is obsolete, use DCAgent.isReady() instead"),Vt.getReadyState()}}),e.isReady=Ft});